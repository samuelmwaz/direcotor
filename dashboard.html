<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNS Director | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05080f;
            --surface: #0a1020;
            --card: #0d1528;
            --border: rgba(255,255,255,0.06);
            --border-bright: rgba(41,170,255,0.2);
            --text: #ddeeff;
            --muted: #4a6a88;
            --urgent: #ff2d55;
            --warning: #ffc600;
            --safe: #00e5a0;
            --accent: #29aaff;
            --accent-dim: rgba(41,170,255,0.1);
            --manual: #b97cff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(41,170,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(41,170,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        .hdr {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 58px;
            background: rgba(5,8,15,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px;
            z-index: 100;
        }
        .hdr-logo { font-family:'IBM Plex Mono',monospace; font-size:.65rem; font-weight:700; color:var(--accent); letter-spacing:.2em; }
        .hdr-title { font-size:1rem; font-weight:800; letter-spacing:-0.01em; }
        .hdr-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }
        .hdr-date {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.58rem;
            color: var(--muted);
            letter-spacing: 0.08em;
        }
        .status-dot {
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.55rem;
            color: var(--safe);
            letter-spacing: 0.1em;
        }
        .status-dot::before {
            content: '';
            width: 5px; height: 5px;
            background: var(--safe);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--safe);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .scroll-area {
            position: relative;
            z-index: 1;
            padding: 74px 14px 110px;
        }

        /* Hero greeting */
        .hero {
            background: linear-gradient(135deg, #0d1528 0%, #091422 100%);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 14px;
            padding: 18px 18px 16px;
            margin-bottom: 0;
        }
        .hero-greeting {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            color: var(--muted);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .hero-name {
            font-size: 1.3rem;
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 10px;
        }
        .hero-name span { color: var(--accent); }
        .hero-summary {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            line-height: 1.6;
        }
        .hero-summary strong { color: var(--text); font-weight: 600; }

        /* Section title */
        .st {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.58rem;
            font-weight: 600;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--muted);
            margin: 22px 0 10px 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .st::after { content:''; flex:1; height:1px; background:var(--border); }

        /* KPI grid */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .kpi-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 14px;
            text-decoration: none;
            display: block;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
        }
        .kpi-card.kp-actions::before  { background: var(--accent); }
        .kpi-card.kp-meetings::before { background: var(--safe); }
        .kpi-card.kp-critical::before { background: var(--urgent); }
        .kpi-card.kp-audit::before    { background: var(--manual); }

        .kpi-card:active { background: rgba(255,255,255,0.02); }

        .kpi-val {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 6px;
        }
        .kp-actions  .kpi-val { color: var(--accent); }
        .kp-meetings .kpi-val { color: var(--safe); }
        .kp-critical .kpi-val { color: var(--urgent); }
        .kp-audit    .kpi-val { color: var(--manual); }

        .kpi-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }
        .kpi-sub {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.58rem;
            color: var(--muted);
        }
        .kpi-arrow {
            position: absolute;
            bottom: 14px; right: 14px;
            font-size: 0.8rem;
            color: var(--muted);
            opacity: 0.4;
        }

        /* Upcoming meeting banner */
        .next-meeting {
            background: rgba(0,229,160,0.06);
            border: 1px solid rgba(0,229,160,0.2);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .next-meeting.none {
            background: var(--card);
            border-color: var(--border);
        }
        .next-icon {
            font-size: 1.6rem;
            flex-shrink: 0;
        }
        .next-body { flex: 1; min-width: 0; }
        .next-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.55rem;
            color: var(--safe);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        .next-meeting.none .next-label { color: var(--muted); }
        .next-title { font-size: 0.9rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .next-meta {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.62rem;
            color: var(--muted);
            margin-top: 3px;
        }
        .next-date-badge {
            background: rgba(0,229,160,0.1);
            border: 1px solid rgba(0,229,160,0.25);
            border-radius: 10px;
            padding: 8px 12px;
            text-align: center;
            flex-shrink: 0;
        }
        .next-date-badge .nd { font-family:'IBM Plex Mono',monospace; font-size:1.2rem; font-weight:700; color:var(--safe); line-height:1; }
        .next-date-badge .nm { font-family:'IBM Plex Mono',monospace; font-size:0.5rem; text-transform:uppercase; color:var(--muted); margin-top:3px; letter-spacing:0.1em; }

        /* Critical actions strip */
        .crit-strip {
            background: rgba(255,45,85,0.05);
            border: 1px solid rgba(255,45,85,0.15);
            border-radius: 14px;
            overflow: hidden;
        }
        .crit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,45,85,0.1);
        }
        .crit-item:last-child { border-bottom: none; }
        .crit-dot { width:8px; height:8px; border-radius:50%; background:var(--urgent); box-shadow:0 0 6px var(--urgent); flex-shrink:0; }
        .crit-text { font-size: 0.85rem; font-weight: 600; flex: 1; }
        .crit-owner { font-family:'IBM Plex Mono',monospace; font-size:0.58rem; color:var(--muted); }

        /* Recent activity */
        .activity-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }
        .ae {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            animation: fadeIn 0.25s ease both;
        }
        .ae:last-child { border-bottom: none; }
        @keyframes fadeIn { from{opacity:0;transform:translateX(-4px);} to{opacity:1;transform:translateX(0);} }

        .ldot { width:8px; height:8px; border-radius:50%; margin-top:5px; flex-shrink:0; }
        .ae-body { flex: 1; min-width: 0; }
        .ae-text { font-size:0.83rem; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .ae-time { font-family:'IBM Plex Mono',monospace; font-size:0.6rem; color:var(--muted); margin-top:3px; }
        .ae-type {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
            margin-top: 3px;
        }
        .type-Action  { background:rgba(41,170,255,0.12); color:var(--accent); }
        .type-Meeting { background:rgba(0,229,160,0.1); color:var(--safe); }
        .type-Manual  { background:rgba(185,124,255,0.1); color:var(--manual); }

        /* Quick nav */
        .quick-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .qn-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.2s, background 0.2s;
        }
        .qn-card:active { background: rgba(255,255,255,0.02); border-color: var(--accent); }
        .qn-ico { font-size: 1.4rem; flex-shrink: 0; }
        .qn-label { font-size: 0.85rem; font-weight: 700; color: var(--text); }
        .qn-sub { font-family:'IBM Plex Mono',monospace; font-size:0.58rem; color:var(--muted); margin-top:2px; }
        .qn-arrow { margin-left: auto; color: var(--muted); opacity: 0.4; font-size: 1rem; }

        /* Empty */
        .empty-msg {
            text-align: center;
            padding: 20px;
            color: var(--muted);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72rem;
        }

        /* Report Button */
        .report-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px;
            margin-top: 22px;
            background: linear-gradient(135deg, rgba(41,170,255,0.15), rgba(41,170,255,0.05));
            border: 1px solid var(--border-bright);
            border-radius: 14px;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .report-btn:active { background: rgba(41,170,255,0.2); }
        .report-btn-icon { font-size: 1.2rem; }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(5,8,15,0.85);
            backdrop-filter: blur(8px);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-box {
            background: #0d1528;
            border: 1px solid var(--border-bright);
            border-radius: 20px 20px 0 0;
            padding: 24px 20px max(24px, env(safe-area-inset-bottom));
            width: 100%;
            max-width: 520px;
            animation: slideUp 0.25s ease;
        }
        @keyframes slideUp { from{transform:translateY(40px);opacity:0;} to{transform:translateY(0);opacity:1;} }
        .modal-title {
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .modal-sub {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            color: var(--muted);
            margin-bottom: 20px;
            letter-spacing: 0.08em;
        }
        .modal-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .modal-opt {
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }
        .modal-opt.selected {
            border-color: var(--accent);
            background: rgba(41,170,255,0.08);
        }
        .modal-opt-ico { font-size: 1.3rem; flex-shrink: 0; }
        .modal-opt-label { font-size: 0.88rem; font-weight: 700; color: var(--text); }
        .modal-opt-desc { font-family: 'IBM Plex Mono', monospace; font-size: 0.58rem; color: var(--muted); margin-top: 2px; }
        .modal-check {
            margin-left: auto;
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: background 0.15s, border-color 0.15s;
        }
        .modal-opt.selected .modal-check {
            background: var(--accent);
            border-color: var(--accent);
        }
        .modal-check::after { content:''; display:none; width:6px; height:6px; border-radius:50%; background:#fff; }
        .modal-opt.selected .modal-check::after { display:block; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-cancel {
            flex: 1;
            padding: 13px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--muted);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            cursor: pointer;
        }
        .modal-generate {
            flex: 2;
            padding: 13px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: #05080f;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .modal-generate:active { opacity: 0.8; }

        /* Nav */
        .bnav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(5,8,15,0.97);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nv {
            flex: 1;
            text-align: center;
            color: var(--muted);
            text-decoration: none;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 4px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            transition: color 0.2s;
        }
        .nv .ico { font-size: 1.1rem; }
        .nv.active { color: var(--accent); }
    </style>
</head>
<body>

<div class="hdr">
    <div>
        <div class="hdr-logo">CNS Portal</div>
        <div class="hdr-title">Director's Brief</div>
    </div>
    <div class="hdr-right">
        <div class="hdr-date" id="hdr-date"></div>
        <div class="status-dot">LIVE</div>
    </div>
</div>

<div class="scroll-area">

    <!-- Hero -->
    <div class="hero">
        <div class="hero-greeting">Good <span id="time-of-day">morning</span></div>
        <div class="hero-name">Director's <span>Brief</span></div>
        <div class="hero-summary" id="hero-summary">Loading operational status‚Ä¶</div>
    </div>

    <!-- KPIs -->
    <div class="st">Operational Overview</div>
    <div class="kpi-grid">
        <a href="action.html" class="kpi-card kp-actions">
            <div class="kpi-val" id="count-actions">0</div>
            <div class="kpi-label">Pending Tasks</div>
            <div class="kpi-sub" id="kpi-sub-actions">‚Äî</div>
            <span class="kpi-arrow">‚Ä∫</span>
        </a>
        <a href="meetings.html" class="kpi-card kp-meetings">
            <div class="kpi-val" id="count-meetings">0</div>
            <div class="kpi-label">Meetings</div>
            <div class="kpi-sub" id="kpi-sub-meetings">‚Äî</div>
            <span class="kpi-arrow">‚Ä∫</span>
        </a>
        <a href="action.html" class="kpi-card kp-critical">
            <div class="kpi-val" id="count-critical">0</div>
            <div class="kpi-label">Critical</div>
            <div class="kpi-sub">Urgent actions</div>
            <span class="kpi-arrow">‚Ä∫</span>
        </a>
        <a href="audit.html" class="kpi-card kp-audit">
            <div class="kpi-val" id="count-audit">0</div>
            <div class="kpi-label">Log Entries</div>
            <div class="kpi-sub">Total recorded</div>
            <span class="kpi-arrow">‚Ä∫</span>
        </a>
    </div>

    <!-- Next Meeting -->
    <div class="st">Next Meeting</div>
    <div id="next-meeting-card"></div>

    <!-- Critical Actions -->
    <div id="critical-section" style="display:none;">
        <div class="st">Critical Actions</div>
        <div class="crit-strip" id="critical-list"></div>
    </div>

    <!-- Recent Activity -->
    <div class="st">Recent Activity</div>
    <div class="activity-card" id="dash-audit"></div>

    <!-- Quick Nav -->
    <div class="st">Quick Access</div>
    <div class="quick-nav">
        <a href="action.html" class="qn-card">
            <span class="qn-ico">‚úÖ</span>
            <div>
                <div class="qn-label">Tasks</div>
                <div class="qn-sub">Action items</div>
            </div>
            <span class="qn-arrow">‚Ä∫</span>
        </a>
        <a href="meetings.html" class="qn-card">
            <span class="qn-ico">üìÖ</span>
            <div>
                <div class="qn-label">Schedule</div>
                <div class="qn-sub">Meetings</div>
            </div>
            <span class="qn-arrow">‚Ä∫</span>
        </a>
        <a href="audit.html" class="qn-card">
            <span class="qn-ico">üîç</span>
            <div>
                <div class="qn-label">Audit Log</div>
                <div class="qn-sub">Activity trail</div>
            </div>
            <span class="qn-arrow">‚Ä∫</span>
        </a>
        <a href="meetings.html" class="qn-card">
            <span class="qn-ico">‚ûï</span>
            <div>
                <div class="qn-label">New Meeting</div>
                <div class="qn-sub">Schedule now</div>
            </div>
            <span class="qn-arrow">‚Ä∫</span>
        </a>
    </div>

    <!-- Report Button -->
    <button class="report-btn" onclick="openReportModal()">
        <span class="report-btn-icon">üìÑ</span>
        Export PDF Report
    </button>

</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-box">
        <div class="modal-title">Generate PDF Report</div>
        <div class="modal-sub">SELECT WHAT TO INCLUDE IN THE REPORT</div>
        <div class="modal-options">
            <div class="modal-opt selected" data-key="all" onclick="toggleOpt(this)">
                <span class="modal-opt-ico">üìã</span>
                <div>
                    <div class="modal-opt-label">Full Report</div>
                    <div class="modal-opt-desc">Everything + analysis chart</div>
                </div>
                <div class="modal-check"></div>
            </div>
            <div class="modal-opt" data-key="tasks" onclick="toggleOpt(this)">
                <span class="modal-opt-ico">‚úÖ</span>
                <div>
                    <div class="modal-opt-label">Pending Tasks</div>
                    <div class="modal-opt-desc">All action items with priority</div>
                </div>
                <div class="modal-check"></div>
            </div>
            <div class="modal-opt" data-key="meetings" onclick="toggleOpt(this)">
                <span class="modal-opt-ico">üìÖ</span>
                <div>
                    <div class="modal-opt-label">Meetings</div>
                    <div class="modal-opt-desc">Scheduled meetings & dates</div>
                </div>
                <div class="modal-check"></div>
            </div>
            <div class="modal-opt" data-key="audit" onclick="toggleOpt(this)">
                <span class="modal-opt-ico">üîç</span>
                <div>
                    <div class="modal-opt-label">Audit Log</div>
                    <div class="modal-opt-desc">Activity history trail</div>
                </div>
                <div class="modal-check"></div>
            </div>
            <div class="modal-opt" data-key="chart" onclick="toggleOpt(this)">
                <span class="modal-opt-ico">üìä</span>
                <div>
                    <div class="modal-opt-label">Analysis Chart</div>
                    <div class="modal-opt-desc">Most active categories graph</div>
                </div>
                <div class="modal-check"></div>
            </div>
        </div>
        <div class="modal-btns">
            <button class="modal-cancel" onclick="closeReportModal()">Cancel</button>
            <button class="modal-generate" onclick="generatePDF()">‚¨á Generate PDF</button>
        </div>
    </div>
</div>

<!-- Hidden canvas for chart generation -->
<canvas id="reportChart" style="display:none; width:500px; height:280px;"></canvas>

<nav class="bnav">
    <a href="dashboard.html" class="nv active"><span class="ico">üè†</span><span>Dash</span></a>
    <a href="action.html"    class="nv"><span class="ico">‚úÖ</span><span>Actions</span></a>
    <a href="meetings.html"  class="nv"><span class="ico">üìÖ</span><span>Meetings</span></a>
    <a href="audit.html"     class="nv"><span class="ico">üîç</span><span>Audit</span></a>
</nav>

<script>
    function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function cleanText(raw) {
        return raw
            .replace(/^ACTION ADDED:\s*/i, '')
            .replace(/^ACTION COMPLETED:\s*/i, '')
            .replace(/^MEETING SCHEDULED:\s*/i, '')
            .replace(/^MEETING REMOVED:\s*/i, '')
            .replace(/^MANUAL:\s*/i, '');
    }

    function updateDashboard() {
        const auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
        const actions  = JSON.parse(localStorage.getItem('actions'))  || [];
        const meetings = JSON.parse(localStorage.getItem('meetings'))  || [];

        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const hour = now.getHours();

        // Header date
        document.getElementById('hdr-date').textContent =
            now.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}).toUpperCase();

        // Time of day
        const tod = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
        document.getElementById('time-of-day').textContent = tod;

        // KPIs
        const critCount = actions.filter(a => a.prio === 'Critical').length;
        const highCount = actions.filter(a => a.prio === 'High').length;
        const upcomingMeetings = meetings.filter(m => m.date >= todayStr).length;

        document.getElementById('count-actions').textContent  = actions.length;
        document.getElementById('count-meetings').textContent = meetings.length;
        document.getElementById('count-critical').textContent = critCount;
        document.getElementById('count-audit').textContent    = auditLog.length;

        document.getElementById('kpi-sub-actions').textContent  =
            critCount > 0 ? `${critCount} critical` : highCount > 0 ? `${highCount} high prio` : 'All clear';
        document.getElementById('kpi-sub-meetings').textContent =
            upcomingMeetings > 0 ? `${upcomingMeetings} upcoming` : 'None scheduled';

        // Hero summary
        const parts = [];
        if (actions.length > 0) parts.push(`<strong>${actions.length} active task${actions.length !== 1 ? 's' : ''}</strong>`);
        if (critCount > 0)       parts.push(`<strong style="color:var(--urgent)">${critCount} critical</strong>`);
        if (upcomingMeetings > 0) parts.push(`<strong>${upcomingMeetings} upcoming meeting${upcomingMeetings !== 1 ? 's' : ''}</strong>`);
        document.getElementById('hero-summary').innerHTML =
            parts.length > 0 ? parts.join(' ¬∑ ') : 'No pending items. All clear.';

        // Next meeting
        const sorted = meetings.filter(m => m.date >= todayStr)
            .sort((a,b) => new Date(a.date) - new Date(b.date));
        const nmCard = document.getElementById('next-meeting-card');
        if (sorted.length > 0) {
            const m = sorted[0];
            const d = new Date(m.date + 'T12:00:00');
            const day = String(d.getDate()).padStart(2, '0');
            const mon = d.toLocaleString('en', {month:'short'}).toUpperCase();
            const dow = d.toLocaleString('en', {weekday:'long'});
            const isToday = m.date === todayStr;
            nmCard.innerHTML = `
                <div class="next-meeting">
                    <div class="next-date-badge">
                        <div class="nd">${day}</div>
                        <div class="nm">${mon}</div>
                    </div>
                    <div class="next-body">
                        <div class="next-label">${isToday ? '‚ñ∂ Today' : 'Next Up'}</div>
                        <div class="next-title">${escHtml(m.title)}</div>
                        <div class="next-meta">${m.time || '--:--'} ¬∑ ${dow} ¬∑ ${m.owner}</div>
                    </div>
                </div>`;
        } else {
            nmCard.innerHTML = `
                <div class="next-meeting none">
                    <div class="next-icon">üìÖ</div>
                    <div class="next-body">
                        <div class="next-label">Next Up</div>
                        <div class="next-title" style="color:var(--muted); font-weight:400;">No upcoming meetings</div>
                    </div>
                </div>`;
        }

        // Critical actions strip
        const critActions = actions.filter(a => a.prio === 'Critical');
        const critSection = document.getElementById('critical-section');
        if (critActions.length > 0) {
            critSection.style.display = 'block';
            document.getElementById('critical-list').innerHTML = critActions.slice(0, 3).map(a => `
                <div class="crit-item">
                    <div class="crit-dot"></div>
                    <div class="crit-text">${escHtml(a.text)}</div>
                    <div class="crit-owner">${a.owner}</div>
                </div>
            `).join('');
        } else {
            critSection.style.display = 'none';
        }

        // Recent activity
        const dau = document.getElementById('dash-audit');
        if (!auditLog.length) {
            dau.innerHTML = '<div class="empty-msg">No recent activity</div>';
        } else {
            dau.innerHTML = auditLog.slice().reverse().slice(0, 5).map((e, i) => `
                <div class="ae" style="animation-delay:${i * 0.04}s">
                    <div class="ldot" style="background:${e.color || 'var(--accent)'}; box-shadow:0 0 5px ${e.color || 'var(--accent)'}40;"></div>
                    <div class="ae-body">
                        <div class="ae-text">${escHtml(cleanText(e.text || ''))}</div>
                        <div class="ae-time">${e.time || '--:--'} ¬∑ ${e.date}</div>
                    </div>
                    <span class="ae-type type-${e.type || 'Manual'}">${e.type || 'LOG'}</span>
                </div>
            `).join('');
        }
    }

    document.addEventListener('DOMContentLoaded', updateDashboard);
</script>

<!-- PDF & Chart Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
    // ‚îÄ‚îÄ Modal logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let selectedOptions = new Set(['all']);

    function openReportModal() {
        document.getElementById('reportModal').classList.add('open');
    }
    function closeReportModal() {
        document.getElementById('reportModal').classList.remove('open');
    }
    // Close on backdrop click
    document.getElementById('reportModal').addEventListener('click', function(e) {
        if (e.target === this) closeReportModal();
    });

    function toggleOpt(el) {
        const key = el.dataset.key;
        if (key === 'all') {
            // Select only "all"
            document.querySelectorAll('.modal-opt').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedOptions = new Set(['all']);
        } else {
            // Deselect "all"
            const allOpt = document.querySelector('.modal-opt[data-key="all"]');
            allOpt.classList.remove('selected');
            selectedOptions.delete('all');
            // Toggle this option
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                selectedOptions.delete(key);
                // If nothing selected, re-select all
                if (selectedOptions.size === 0) {
                    allOpt.classList.add('selected');
                    selectedOptions.add('all');
                }
            } else {
                el.classList.add('selected');
                selectedOptions.add(key);
            }
        }
    }

    // ‚îÄ‚îÄ Chart builder (returns base64 PNG) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildChartImage() {
        return new Promise(resolve => {
            const auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
            const actions  = JSON.parse(localStorage.getItem('actions'))  || [];
            const meetings = JSON.parse(localStorage.getItem('meetings'))  || [];

            // Count by type
            const typeCounts = {};
            auditLog.forEach(e => {
                const t = e.type || 'Manual';
                typeCounts[t] = (typeCounts[t] || 0) + 1;
            });

            // Priority breakdown for tasks
            const critCount = actions.filter(a => a.prio === 'Critical').length;
            const highCount = actions.filter(a => a.prio === 'High').length;
            const medCount  = actions.filter(a => a.prio === 'Medium').length;
            const lowCount  = actions.filter(a => a.prio === 'Low').length;

            const canvas = document.getElementById('reportChart');
            canvas.width = 500;
            canvas.height = 300;
            canvas.style.display = 'block';

            // Destroy existing chart if any
            if (window._reportChartInstance) {
                window._reportChartInstance.destroy();
            }

            const labels = [];
            const data   = [];
            const colors = [];

            // Audit types
            Object.entries(typeCounts).forEach(([k,v]) => {
                labels.push(k + ' Logs');
                data.push(v);
                colors.push(k === 'Action' ? '#29aaff' : k === 'Meeting' ? '#00e5a0' : '#b97cff');
            });

            // Task priorities
            if (critCount) { labels.push('Critical Tasks'); data.push(critCount); colors.push('#ff2d55'); }
            if (highCount) { labels.push('High Prio Tasks'); data.push(highCount); colors.push('#ffc600'); }
            if (medCount)  { labels.push('Medium Tasks');   data.push(medCount);  colors.push('#29aaff'); }
            if (lowCount)  { labels.push('Low Prio Tasks'); data.push(lowCount);  colors.push('#4a6a88'); }
            if (meetings.length) { labels.push('Meetings'); data.push(meetings.length); colors.push('#00e5a0'); }

            // Sort by value desc
            const combined = labels.map((l,i) => ({l, v: data[i], c: colors[i]}));
            combined.sort((a,b) => b.v - a.v);

            window._reportChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: combined.map(x=>x.l),
                    datasets: [{
                        label: 'Count',
                        data: combined.map(x=>x.v),
                        backgroundColor: combined.map(x=>x.c + 'cc'),
                        borderColor: combined.map(x=>x.c),
                        borderWidth: 2,
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: false,
                    animation: { onComplete: () => {
                        const img = canvas.toDataURL('image/png');
                        canvas.style.display = 'none';
                        resolve(img);
                    }},
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Activity Analysis ‚Äî Most Active Categories',
                            color: '#ddeeff',
                            font: { size: 13, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#4a6a88', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#4a6a88', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        });
    }

    // ‚îÄ‚îÄ PDF Generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function generatePDF() {
        const btn = document.querySelector('.modal-generate');
        btn.textContent = '‚è≥ Building‚Ä¶';
        btn.disabled = true;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        const auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
        const actions  = JSON.parse(localStorage.getItem('actions'))  || [];
        const meetings = JSON.parse(localStorage.getItem('meetings'))  || [];

        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}).toUpperCase();
        const timeStr = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

        const doAll      = selectedOptions.has('all');
        const doTasks    = doAll || selectedOptions.has('tasks');
        const doMeetings = doAll || selectedOptions.has('meetings');
        const doAudit    = doAll || selectedOptions.has('audit');
        const doChart    = doAll || selectedOptions.has('chart');

        // Colours (as hex for jsPDF)
        const C_BG      = [5, 8, 15];
        const C_CARD    = [13, 21, 40];
        const C_ACCENT  = [41, 170, 255];
        const C_SAFE    = [0, 229, 160];
        const C_URGENT  = [255, 45, 85];
        const C_WARN    = [255, 198, 0];
        const C_MUTED   = [74, 106, 136];
        const C_TEXT    = [221, 238, 255];
        const C_MANUAL  = [185, 124, 255];

        const pw = 210; // page width mm
        const ph = 297; // page height mm
        const ml = 14;  // margin left
        const mr = 14;  // margin right
        const cw = pw - ml - mr; // content width
        let y = 0;

        function newPage() {
            doc.addPage();
            // Background
            doc.setFillColor(...C_BG);
            doc.rect(0, 0, pw, ph, 'F');
            y = 20;
        }

        function checkY(needed) {
            if (y + needed > ph - 20) newPage();
        }

        // ‚îÄ‚îÄ Cover ‚îÄ‚îÄ
        doc.setFillColor(...C_BG);
        doc.rect(0, 0, pw, ph, 'F');

        // Accent line
        doc.setFillColor(...C_ACCENT);
        doc.rect(0, 0, 3, ph, 'F');

        // Title block
        y = 40;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(...C_MUTED);
        doc.text('CNS PORTAL  ¬∑  DIRECTOR\'S BRIEF', ml, y);
        y += 14;

        doc.setFontSize(28);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...C_TEXT);
        doc.text('Operations', ml, y);
        y += 10;
        doc.setTextColor(...C_ACCENT);
        doc.text('Report', ml, y);
        y += 16;

        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...C_MUTED);
        doc.text(`Generated: ${dateStr}  ¬∑  ${timeStr}`, ml, y);
        y += 30;

        // KPI summary boxes
        const kpiData = [
            { label: 'Pending Tasks', val: actions.length, color: C_ACCENT },
            { label: 'Meetings', val: meetings.length, color: C_SAFE },
            { label: 'Critical', val: actions.filter(a=>a.prio==='Critical').length, color: C_URGENT },
            { label: 'Log Entries', val: auditLog.length, color: C_MANUAL },
        ];
        const kw = (cw - 9) / 4;
        kpiData.forEach((k, i) => {
            const x = ml + i * (kw + 3);
            doc.setFillColor(...C_CARD);
            doc.roundedRect(x, y, kw, 22, 3, 3, 'F');
            doc.setFillColor(...k.color);
            doc.rect(x, y, kw, 1.5, 'F');
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...k.color);
            doc.text(String(k.val), x + kw/2, y + 12, { align: 'center' });
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...C_MUTED);
            doc.text(k.label, x + kw/2, y + 18, { align: 'center' });
        });
        y += 32;

        // ‚îÄ‚îÄ Analysis Chart ‚îÄ‚îÄ
        if (doChart) {
            checkY(80);
            doc.setFillColor(...C_CARD);
            doc.roundedRect(ml, y, cw, 8, 2, 2, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...C_ACCENT);
            doc.text('ACTIVITY ANALYSIS', ml + 4, y + 5.5);
            y += 12;

            try {
                const chartImg = await buildChartImage();
                const imgH = (cw * 300) / 500;
                checkY(imgH + 5);
                doc.addImage(chartImg, 'PNG', ml, y, cw, imgH);
                y += imgH + 8;
            } catch(e) {
                doc.setTextColor(...C_MUTED);
                doc.text('Chart unavailable', ml, y + 5);
                y += 12;
            }
        }

        // ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ
        if (doTasks && actions.length > 0) {
            checkY(20);
            doc.setFillColor(...C_CARD);
            doc.roundedRect(ml, y, cw, 8, 2, 2, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...C_ACCENT);
            doc.text('PENDING TASKS', ml + 4, y + 5.5);
            y += 12;

            actions.forEach((a, i) => {
                checkY(14);
                const prioColor = a.prio === 'Critical' ? C_URGENT : a.prio === 'High' ? C_WARN : a.prio === 'Medium' ? C_ACCENT : C_MUTED;
                doc.setFillColor(...C_CARD);
                doc.roundedRect(ml, y, cw, 11, 2, 2, 'F');
                doc.setFillColor(...prioColor);
                doc.circle(ml + 5, y + 5.5, 1.5, 'F');
                doc.setFontSize(8.5);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...C_TEXT);
                const taskText = doc.splitTextToSize(a.text || '‚Äî', cw - 40);
                doc.text(taskText[0], ml + 10, y + 5.5);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...prioColor);
                doc.text(a.prio || '‚Äî', ml + cw - 3, y + 5.5, { align: 'right' });
                doc.setTextColor(...C_MUTED);
                doc.text(a.owner || '‚Äî', ml + 10, y + 9);
                y += 13;
            });
            y += 4;
        }

        // ‚îÄ‚îÄ Meetings ‚îÄ‚îÄ
        if (doMeetings && meetings.length > 0) {
            checkY(20);
            doc.setFillColor(...C_CARD);
            doc.roundedRect(ml, y, cw, 8, 2, 2, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...C_SAFE);
            doc.text('MEETINGS', ml + 4, y + 5.5);
            y += 12;

            meetings.sort((a,b) => a.date > b.date ? 1 : -1).forEach(m => {
                checkY(14);
                doc.setFillColor(...C_CARD);
                doc.roundedRect(ml, y, cw, 11, 2, 2, 'F');
                doc.setFillColor(...C_SAFE);
                doc.circle(ml + 5, y + 5.5, 1.5, 'F');
                doc.setFontSize(8.5);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...C_TEXT);
                doc.text(m.title || '‚Äî', ml + 10, y + 5.5);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...C_MUTED);
                doc.text(`${m.date || '‚Äî'}  ¬∑  ${m.time || '--:--'}  ¬∑  ${m.owner || '‚Äî'}`, ml + 10, y + 9);
                y += 13;
            });
            y += 4;
        }

        // ‚îÄ‚îÄ Audit Log ‚îÄ‚îÄ
        if (doAudit && auditLog.length > 0) {
            checkY(20);
            doc.setFillColor(...C_CARD);
            doc.roundedRect(ml, y, cw, 8, 2, 2, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...C_MANUAL);
            doc.text('AUDIT LOG', ml + 4, y + 5.5);
            y += 12;

            auditLog.slice().reverse().forEach(e => {
                checkY(14);
                const eColor = e.type === 'Action' ? C_ACCENT : e.type === 'Meeting' ? C_SAFE : C_MANUAL;
                doc.setFillColor(...C_CARD);
                doc.roundedRect(ml, y, cw, 11, 2, 2, 'F');
                doc.setFillColor(...eColor);
                doc.circle(ml + 5, y + 5.5, 1.5, 'F');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...C_TEXT);
                const entryText = doc.splitTextToSize((e.text || '‚Äî').replace(/^(ACTION ADDED:|ACTION COMPLETED:|MEETING SCHEDULED:|MEETING REMOVED:|MANUAL:)\s*/i,''), cw - 30);
                doc.text(entryText[0], ml + 10, y + 5.5);
                doc.setFontSize(6.5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...C_MUTED);
                doc.text(`${e.date || '‚Äî'}  ¬∑  ${e.time || '--:--'}`, ml + 10, y + 9);
                doc.setTextColor(...eColor);
                doc.text(e.type || 'LOG', ml + cw - 3, y + 5.5, { align: 'right' });
                y += 13;
            });
        }

        // Footer on last page
        const totalPages = doc.getNumberOfPages();
        for (let p = 1; p <= totalPages; p++) {
            doc.setPage(p);
            doc.setFillColor(...C_ACCENT);
            doc.rect(0, ph - 1.5, pw, 1.5, 'F');
            doc.setFontSize(6.5);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...C_MUTED);
            doc.text(`CNS DIRECTOR'S BRIEF  ¬∑  ${dateStr}`, ml, ph - 5);
            doc.text(`PAGE ${p} / ${totalPages}`, pw - mr, ph - 5, { align: 'right' });
        }

        doc.save(`CNS_Report_${dateStr.replace(/ /g,'_')}.pdf`);

        btn.textContent = '‚¨á Generate PDF';
        btn.disabled = false;
        closeReportModal();
    }
</script>

</body>
</html>
